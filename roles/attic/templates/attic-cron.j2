#!/bin/sh

# default binary installation is not in PATH
ATTIC=/usr/local/bin/attic
REPOSITORY={{ attic_repository }}
export ATTIC_PASSPHRASE={{ attic_passphrase }}

# wrap backup steps around maintenance mode
sudo -u www-data php /var/www/owncloud/occ maintenance:mode --on
sqlite3 /var/www/owncloud/data/owncloud.db '.backup /var/www/owncloud/data/backup-owncloud.db'

$ATTIC create --stats                                \
    $REPOSITORY::owncloud-`date +%Y-%m-%d_%H`        \
    /var/www/owncloud/                               \
    --exclude '/var/www/owncloud/data/owncloud.*.db' \

rm /var/www/owncloud/data/backup-owncloud.db
sudo -u www-data php /var/www/owncloud/occ maintenance:mode --off

$ATTIC check $REPOSITORY
if [ $? -eq 0 ] ; then
    $ATTIC prune -v $REPOSITORY --keep-hourly=24 --keep-daily=7 --keep-weekly=4 --keep-monthly=6
    s3cmd --delete-removed sync $REPOSITORY {{ s3_thebluebox_bucket }}
fi
